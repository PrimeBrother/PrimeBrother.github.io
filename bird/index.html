<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>小小鸟飞呀飞</title>

    <style>

        canvas {
            border: 1px solid #cccccc;
        }

    </style>

</head>

<body>
<canvas width="800" height="600" id="myCanvas"></canvas>
<script src="sky.js"></script>
<script src="bird.js"></script>
<script src="land.js"></script>
<script src="pipe.js"></script>
<script src="myTime.js"></script>

</body>

<script>

    var canvas = document.querySelector("#myCanvas");
    var ctx = canvas.getContext("2d");

    var imgNames = ["birds.png","sky.png","land.png","pipe1.png","pipe2.png"];
    loadImages(imgNames,function (imgs) {

        //此数组存储所有的绘制对象
        var roles = [];

        //Todo 1. 创建天空对象
        for(var i=0;i<2;i++) {
            roles.push(new Sky({
                ctx : ctx,
                image : imgs["sky.png"],
                x : imgs["sky.png"].width * i
            }))
        }

        //创建管道
        for(var i=0;i<6;i++) {
            var pipe = new Pipe({
                ctx : ctx,
                topImage : imgs["pipe2.png"],
                bottomImage : imgs["pipe1.png"],
                x : 500 + 200 * i,
                y : -300  //(-150 ~ -300)
            });
            roles.push(pipe);
        }

        //todo 2. 创建陆地对象
        for(var i=0;i<4;i++) {
            roles.push(new Land({
                ctx : ctx,
                image : imgs["land.png"],
                x : imgs["land.png"].width * i,
                y : canvas.height - imgs["land.png"].height
            }));
        }

        roles.push(new MyTime({
            ctx : ctx
        }));

        //todo 3. 创建小鸟对象
        var bird = new Bird({
            ctx : ctx,
            image : imgs["birds.png"],
            x : 100,
            y : 100
        });
        roles.push(bird);

        var isRunning = true;

        function render() {

            //清除界面
            ctx.clearRect(0,0,canvas.width,canvas.height);

            this.ctx.beginPath();

            //循环取到每一个对象进行绘制
            roles.forEach(function (role) {
                role.draw();
            });

            //判断小鸟的上天入地的处理
            if(bird.y < -10 || bird.y > canvas.height - imgs["land.png"].height-40 ) {
                //游戏结束
                isRunning = false;
            }

            //判断小鸟是否撞击管道
            if(ctx.isPointInPath(bird.x+bird.picW/2, bird.y+bird.picH/2)) {
                //游戏结束
                isRunning = false;
            }

            if(isRunning) {
                requestAnimationFrame(render);
            }

        }

        document.onmousedown = function () {

            //鼠标点击,小鸟向上跳跃
            //因为速度为负数,所以根据加速的公式,计算出来的位移是负数,所以小鸟会往上移动,
            // 然后由于加速的存在,向上移动的速度是减速的
            bird.v = - bird.maxSpeed/2.5;
        }

        render();


    });

    //将角度转出弧度
    function convertAngle(angle) {
        // PI:180 = ?(弧度) : 角度
        // 弧度 = PI/180 * 角度
        return Math.PI / 180 * angle;
    }

    /**
     * 功能 : 可以用来监听多个图片的加载完成
     * @param imgNames 多个图片的名字
     * @param callback 多个图片加载完成回调的函数
     */
    function loadImages(imgNames,callback) {

        //用于记录加载完成的数量
        var count = 0;
        var imgs = {};

        for(var i=0;i<imgNames.length;i++) {

            var img = new Image();
            var imgName = imgNames[i];

            img.src = "../imgs/" + imgName;

            imgs[imgName] = img;

            img.onload = function () {
                count++;

                //判断加载完成的数量是否等于总数
                if(count == imgNames.length) {
                    callback(imgs);
                }

            }

        }
    }

</script>

</html>